<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SpotDL Console</title>
  <style>
    :root{
      --bg: #070a0f;
      --panel: rgba(13, 18, 28, 0.78);
      --panel2: rgba(9, 12, 18, 0.72);
      --text: #cfe7ff;
      --muted: #86a3c3;
      --accent: #00ff9c;
      --accent2: #00d7ff;
      --danger: #ff4d6d;
      --warning: #ffd93d;
      --border: rgba(0, 255, 156, 0.18);
      --shadow: 0 20px 60px rgba(0,0,0,.55);
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }

    * { box-sizing: border-box; }
    body{
      margin: 0;
      min-height: 100vh;
      font-family: var(--sans);
      color: var(--text);
      background:
        radial-gradient(1200px 700px at 20% 10%, rgba(0,215,255,.10), transparent 55%),
        radial-gradient(900px 600px at 85% 20%, rgba(0,255,156,.10), transparent 55%),
        linear-gradient(180deg, #05070b, #070a0f 60%, #05070b);
      padding: 14px;
    }

    body:before{
      content:"";
      position: fixed;
      inset: 0;
      pointer-events: none;
      background-image:
        linear-gradient(rgba(0,255,156,.05) 1px, transparent 1px),
        linear-gradient(90deg, rgba(0,215,255,.04) 1px, transparent 1px);
      background-size: 36px 36px;
      opacity: .35;
    }

    .wrap{ max-width: 1000px; margin: 0 auto; position: relative; z-index: 1; }

    .header{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 10px;
      margin-bottom: 12px;
    }

    .brand{ display:flex; flex-direction:column; gap: 4px; }
    .brand h1{
      margin:0;
      font-family: var(--mono);
      font-size: 18px;
      letter-spacing: .6px;
      font-weight: 700;
    }
    .brand .sub{
      font-family: var(--mono);
      font-size: 11px;
      color: var(--muted);
      line-height: 1.35;
    }

    .pill{
      font-family: var(--mono);
      font-size: 11px;
      padding: 7px 9px;
      border: 1px solid var(--border);
      border-radius: 999px;
      background: rgba(0,255,156,.06);
      color: var(--accent);
      white-space: nowrap;
      align-self: flex-start;
    }

    .panel{
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 16px;
      box-shadow: var(--shadow);
      overflow:hidden;
      margin-bottom: 12px;
    }

    .panel-top{
      padding: 14px;
      border-bottom: 1px solid rgba(0,255,156,.12);
      background: linear-gradient(180deg, rgba(0,255,156,.06), transparent);
    }

    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap: 10px;
      align-items: stretch;
    }

    .label{
      font-family: var(--mono);
      font-size: 12px;
      color: var(--muted);
      margin: 2px 0 6px 2px;
    }

    select, input[type="text"]{
      width: 100%;
      padding: 12px 12px;
      border-radius: 12px;
      border: 1px solid rgba(0,215,255,.18);
      background: var(--panel2);
      color: var(--text);
      font-family: var(--mono);
      outline: none;
    }
    input[type="text"]::placeholder{ color: rgba(134,163,195,.7); }

    select:focus, input[type="text"]:focus{
      border-color: rgba(0,255,156,.45);
      box-shadow: 0 0 0 3px rgba(0,255,156,.12);
    }

    button{
      width: 100%;
      padding: 13px 14px;
      border-radius: 12px;
      border: 1px solid rgba(0,255,156,.35);
      background: linear-gradient(135deg, rgba(0,255,156,.16), rgba(0,215,255,.10));
      color: var(--text);
      cursor: pointer;
      font-family: var(--mono);
      font-weight: 800;
      letter-spacing: .5px;
      transition: transform .12s ease, box-shadow .12s ease, opacity .12s ease;
      white-space: nowrap;
    }
    button:hover{ box-shadow: 0 10px 30px rgba(0,255,156,.12); transform: translateY(-1px); }
    button:active{ transform: translateY(0); }
    button:disabled{ opacity: .55; cursor:not-allowed; transform:none; box-shadow:none; }

    .meta{
      margin-top: 10px;
      font-family: var(--mono);
      font-size: 11px;
      color: var(--muted);
      display:flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items:center;
    }
    .meta code{
      color: var(--accent2);
      background: rgba(0,215,255,.08);
      border: 1px solid rgba(0,215,255,.12);
      padding: 2px 6px;
      border-radius: 8px;
      line-height: 1.35;
    }

    .status{
      display:none;
      margin-top: 12px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(0,215,255,.18);
      background: rgba(0,215,255,.06);
      font-family: var(--mono);
      font-size: 12px;
      animation: fadeIn 0.3s ease;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-5px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .status.show{ display:block; }
    .status.ok{
      border-color: rgba(0,255,156,.28);
      background: rgba(0,255,156,.08);
      color: var(--accent);
    }
    .status.err{
      border-color: rgba(255,77,109,.30);
      background: rgba(255,77,109,.10);
      color: #ffd1da;
    }
    .status.info{ color: var(--text); }
    .status.running{
      border-color: rgba(255,217,61,.30);
      background: rgba(255,217,61,.10);
      color: var(--warning);
    }

    .terminal{ padding: 12px 14px 14px 14px; }
    .term-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom: 10px;
      gap: 8px;
    }
    .term-title{
      font-family: var(--mono);
      font-size: 12px;
      color: var(--muted);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .spinner{
      display: none;
      width: 14px;
      height: 14px;
      border: 2px solid rgba(0,255,156,.2);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    .spinner.active{ display: block; }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .term-actions{ display:flex; gap: 8px; }
    .smallbtn{
      padding: 9px 10px;
      border-radius: 10px;
      font-size: 12px;
      font-weight: 800;
    }

    pre{
      margin: 0;
      padding: 12px;
      border-radius: 14px;
      border: 1px solid rgba(0,255,156,.14);
      background: rgba(2, 6, 12, .72);
      color: #d7fbe9;
      font-family: var(--mono);
      font-size: 12px;
      line-height: 1.55;
      max-height: 60vh;
      overflow: auto;
      white-space: pre-wrap;
      word-break: break-word;
    }

    /* Syntax highlighting for output */
    .log-success{ color: var(--accent); }
    .log-error{ color: var(--danger); }
    .log-warning{ color: var(--warning); }
    .log-info{ color: var(--accent2); }
    .log-dim{ color: var(--muted); }

    .stats{
      display: none;
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(0,215,255,.14);
      background: rgba(2, 6, 12, .5);
      font-family: var(--mono);
      font-size: 11px;
      color: var(--muted);
    }
    .stats.show{ display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 8px; }
    .stat-item{
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .stat-label{ color: var(--muted); font-size: 10px; }
    .stat-value{ color: var(--accent2); font-size: 13px; font-weight: 700; }

    .hint{
      margin-top: 10px;
      font-family: var(--mono);
      font-size: 11px;
      color: rgba(134,163,195,.85);
    }

    @media (min-width: 820px){
      body{ padding: 22px; }
      .brand h1{ font-size: 20px; }
      .brand .sub{ font-size: 12px; }
      .grid{
        grid-template-columns: 220px 1fr;
        grid-template-areas:
          "mode url"
          "run  run";
        gap: 12px;
        align-items:end;
      }
      .mode { grid-area: mode; }
      .url  { grid-area: url; }
      .run  { grid-area: run; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <div class="brand">
        <h1>SPOTDL_CONSOLE</h1>
        <div class="sub">FLAC • 320k • Genius lyrics • verified results • Real-time output</div>
      </div>
      <div class="pill">AUTH: SESSION_TOKEN</div>
    </div>

    <div class="panel">
      <div class="panel-top">
        <div class="grid">
          <div class="mode">
            <div class="label">Mode</div>
            <select id="mode" onchange="updateCommandHint()">
              <option value="track">Track</option>
              <option value="albums">Albums (fetch)</option>
              <option value="playlist">Playlist</option>
            </select>
          </div>

          <div class="url">
            <div class="label">Spotify URL</div>
            <input id="url" type="text" placeholder="https://open.spotify.com/..." autocomplete="off" />
          </div>

          <div class="run">
            <div class="label">&nbsp;</div>
            <button id="btn" onclick="run()">RUN</button>
          </div>
        </div>

        <div class="meta">
          <div>Command:</div>
          <code id="cmdhint"></code>
        </div>

        <div id="status" class="status"></div>
        
        <div id="stats" class="stats">
          <div class="stat-item">
            <div class="stat-label">TRACKS FOUND</div>
            <div class="stat-value" id="stat-found">0</div>
          </div>
          <div class="stat-item">
            <div class="stat-label">DOWNLOADED</div>
            <div class="stat-value" id="stat-downloaded">0</div>
          </div>
          <div class="stat-item">
            <div class="stat-label">ERRORS</div>
            <div class="stat-value" id="stat-errors">0</div>
          </div>
          <div class="stat-item">
            <div class="stat-label">ELAPSED</div>
            <div class="stat-value" id="stat-time">0s</div>
          </div>
        </div>
      </div>

      <div class="terminal">
        <div class="term-head">
          <div class="term-title">
            <span>OUTPUT</span>
            <div class="spinner" id="spinner"></div>
          </div>
          <div class="term-actions">
            <button class="smallbtn" onclick="clearOutput()">CLEAR</button>
            <button class="smallbtn" onclick="copyOutput()">COPY</button>
          </div>
        </div>
        <pre id="output">Ready. Enter a Spotify URL and press RUN.</pre>
        <div class="hint">Tip: press Enter in the URL field to run. Output updates in real-time.</div>
      </div>
    </div>
  </div>

  <script>
    let eventSource = null;
    let startTime = null;
    let timerInterval = null;
    
    const stats = {
      found: 0,
      downloaded: 0,
      errors: 0
    };

    function setStatus(kind, msg){
      const s = document.getElementById('status');
      if(!msg){
        s.className = 'status';
        s.textContent = '';
        return;
      }
      s.className = 'status show ' + (kind || 'info');
      s.textContent = msg;
    }

    function setOutput(text){
      const o = document.getElementById('output');
      o.textContent = text || '';
      o.scrollTop = o.scrollHeight;
    }

    function appendOutput(text){
      const o = document.getElementById('output');
      o.textContent += text;
      o.scrollTop = o.scrollHeight;
    }

    function clearOutput(){
      setOutput('Ready. Enter a Spotify URL and press RUN.');
      setStatus('', '');
      hideStats();
    }

    function showStats(){
      document.getElementById('stats').classList.add('show');
    }

    function hideStats(){
      document.getElementById('stats').classList.remove('show');
      stats.found = 0;
      stats.downloaded = 0;
      stats.errors = 0;
      updateStatsDisplay();
    }

    function updateStatsDisplay(){
      document.getElementById('stat-found').textContent = stats.found;
      document.getElementById('stat-downloaded').textContent = stats.downloaded;
      document.getElementById('stat-errors').textContent = stats.errors;
    }

    function startTimer(){
      startTime = Date.now();
      timerInterval = setInterval(() => {
        const elapsed = Math.floor((Date.now() - startTime) / 1000);
        document.getElementById('stat-time').textContent = elapsed + 's';
      }, 1000);
    }

    function stopTimer(){
      if(timerInterval){
        clearInterval(timerInterval);
        timerInterval = null;
      }
    }

    function parseOutputLine(line){
      // Parse "Found X songs in..." pattern
      const foundMatch = line.match(/Found (\d+) songs? in/i);
      if(foundMatch){
        stats.found = parseInt(foundMatch[1]);
        updateStatsDisplay();
        return `<span class="log-info">${line}</span>`;
      }
      
      // Parse "Downloaded..." pattern
      if(line.includes('Downloaded "') || line.match(/^Downloaded /)){
        stats.downloaded++;
        updateStatsDisplay();
        return `<span class="log-success">${line}</span>`;
      }
      
      // Parse errors - LookupError, AudioProviderError, etc.
      if(line.includes('Error:') || line.includes('LookupError') || line.includes('AudioProviderError') || line.includes('Failed')){
        stats.errors++;
        updateStatsDisplay();
        return `<span class="log-error">${line}</span>`;
      }
      
      // Rate limit warnings
      if(line.includes('rate/request limit')){
        return `<span class="log-warning">${line}</span>`;
      }
      
      // Processing/status lines
      if(line.includes('Processing query') || line.includes('Command:')){
        return `<span class="log-info">${line}</span>`;
      }
      
      // URLs and success indicators
      if(line.includes('https://music.youtube.com') || line.includes('✓')){
        return `<span class="log-dim">${line}</span>`;
      }
      
      return `<span class="log-dim">${line}</span>`;
    }

    async function copyOutput(){
      const text = document.getElementById('output').textContent || '';
      try{
        await navigator.clipboard.writeText(text);
        setStatus('ok', 'Copied output to clipboard.');
        setTimeout(() => setStatus('', ''), 2000);
      }catch(e){
        setStatus('err', 'Copy failed: ' + e.message);
      }
    }

    function updateCommandHint() {
      const mode = document.getElementById('mode').value;
      const el = document.getElementById('cmdhint');

      if (mode === 'albums') {
        el.textContent =
          'spotdl download <URL> --fetch-albums --format flac --bitrate 320k --lyrics genius --only-verified-results ' +
          '--output "{artist}/{album}/{artist} - {title}.{output-ext}"';
      } else if (mode === 'playlist') {
        el.textContent =
          'spotdl download <URL> --format flac --bitrate 320k --lyrics genius --only-verified-results ' +
          '--output "playlists/{list-name}/{artist} - {title}.{output-ext}"';
      } else {
        el.textContent =
          'spotdl download <URL> --format flac --bitrate 320k --lyrics genius --only-verified-results ' +
          '--output "{artist}/{album}/{artist} - {title}.{output-ext}"';
      }
    }

    async function run(){
      const url = document.getElementById('url').value.trim();
      const mode = document.getElementById('mode').value;
      const btn = document.getElementById('btn');
      const spinner = document.getElementById('spinner');

      if(!url){
        setStatus('err', 'Please enter a Spotify URL.');
        return;
      }

      // Close any existing event source
      if(eventSource){
        eventSource.close();
      }

      btn.disabled = true;
      spinner.classList.add('active');
      setStatus('running', 'Initializing download...');
      setOutput('Connecting to SpotDL...\n');
      showStats();
      hideStats();
      stats.found = 0;
      stats.downloaded = 0;
      stats.errors = 0;
      updateStatsDisplay();
      showStats();
      startTimer();

      try{
        // Start SSE connection
        eventSource = new EventSource(`/download/stream?url=${encodeURIComponent(url)}&mode=${mode}`);
        
        eventSource.onmessage = function(event) {
          const data = JSON.parse(event.data);
          
          if(data.type === 'output'){
            appendOutput(data.data);
            
            // Update stats from backend if provided
            if(data.stats){
              stats.found = data.stats.found;
              stats.downloaded = data.stats.downloaded;
              stats.errors = data.stats.errors;
              updateStatsDisplay();
            }
          }
          else if(data.type === 'status'){
            setStatus('running', data.message);
          }
          else if(data.type === 'complete'){
            setStatus('ok', 'Download completed successfully!');
            appendOutput('\n✓ Download complete!\n');
            if(data.message){
              appendOutput(data.message + '\n');
            }
            stopTimer();
            spinner.classList.remove('active');
            btn.disabled = false;
            eventSource.close();
          }
          else if(data.type === 'error'){
            setStatus('err', 'Download failed.');
            appendOutput('\n✗ Error: ' + data.message + '\n');
            stopTimer();
            spinner.classList.remove('active');
            btn.disabled = false;
            eventSource.close();
          }
        };

        eventSource.onerror = function(error) {
          console.error('EventSource error:', error);
          setStatus('err', 'Connection error. Check console for details.');
          stopTimer();
          spinner.classList.remove('active');
          btn.disabled = false;
          if(eventSource){
            eventSource.close();
          }
        };

      }catch(e){
        setStatus('err', 'Request error: ' + e.message);
        stopTimer();
        spinner.classList.remove('active');
        btn.disabled = false;
      }
    }

    document.getElementById('url').addEventListener('keypress', function(e){
      if(e.key === 'Enter') run();
    });

    updateCommandHint();
  </script>
</body>
</html>
